{% extends 'chat/app_base.html' %}

{% block content %}

 <div class="chat-wrapper">
   <div class="messaging">
      <div class="inbox_msg">

        <div class="mesgs">
          <div class="msg_history">
            {% for message in messages%}
              {% if message.sender == request.user %}
              <div class="outgoing_msg">
                <div class="sent_msg">
                  <p>{{message.text}}</p>
                  <span class="time_date">{{message.timestamp}}</span> </div>
              </div>
              {% else %}
              <div class="incoming_msg">
               <div class="incoming_msg_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil"> </div>
               <div class="received_msg">
                   <div class="received_withd_msg">
                     <p>{{message.text}}</p>
                     <span class="time_date"> {{message.timestamp}}</span></div>
               </div>
              </div>
              {% endif%}
            {% endfor %}

          </div>
          <div class="type_msg">
            <div class="input_msg_write">
              <input type="text" id='chat-message-input' required class="write_msg" placeholder="Type a message" />
              <button class="msg_send_btn" id ='chat-message-submit' type="button"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
 </div>
{% endblock %}


{% block js %}
{{ request.user.username|json_script:"user_username" }}

<script>
    //scroll to msost recent messeges
     document.querySelector('.msg_history').lastChild.previousSibling.scrollIntoView(false);

     const current_user = JSON.parse(document.getElementById('user_username').textContent);

     const chatSocket = new WebSocket(
         'ws://'
         + window.location.host
         + '/ws/chat/'
     );

     // add outgoing message to DOM
     addOutgoingMsg = (data) => {
       let history =  document.querySelector('.msg_history')

       history.insertAdjacentHTML('beforeend',
         `<div class="outgoing_msg">
           <div class="sent_msg">
             <p>${data.text}</p>
             <span class="time_date">${data.timestamp}</span> </div>
         </div>`
        )
        history.lastChild.scrollIntoView(false);
     }

     // add incoming message to DOM
     addIncomingMsg = (data) => {
        let history =  document.querySelector('.msg_history')
        history.insertAdjacentHTML('beforeend',
         `<div class="incoming_msg">
          <div class="incoming_msg_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil"> </div>
          <div class="received_msg">
              <div class="received_withd_msg">
                <p>${data.text}</p>
                <span class="time_date"> ${data.timestamp}</span></div>
          </div>
         </div>`
        )
        history.lastChild.scrollIntoView(false);
     }

     chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.sender === current_user) {
          addOutgoingMsg(data)
        } else {
            addIncomingMsg(data)
        }
     };

     chatSocket.onclose = function(e) {
         console.error('Chat socket closed unexpectedly');
     };

     document.querySelector('#chat-message-input').focus();
     document.querySelector('#chat-message-input').onkeyup = function(e) {
         if (e.keyCode === 13) {  // enter, return
             document.querySelector('#chat-message-submit').click();
         }
     };

     document.querySelector('#chat-message-submit').onclick = function(e) {
         const messageInputDom = document.querySelector('#chat-message-input');
         const message = messageInputDom.value;
         if (message){
           chatSocket.send(JSON.stringify({
               'message': message
           }));
           messageInputDom.value = '';
         }

     };
 </script>
{% endblock %}
